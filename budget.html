<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget ‚Äî Budget Manager</title>
    <style>
        :root {
            --primary: #4834d4;
            --secondary: #6c5ce7;
            --accent: #81ecec;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --dark: #2c3e50;
            --light: #f1f2f6;
            --gray: #95a5a6;
            --shadow: 0 6px 24px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6c5ce7 0%, #81ecec 100%) fixed;
            color: #222;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #0f476a;
            color: white;
            text-align: center;
            padding: 1rem 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            background-color: var(--light);
            border-radius: 0.5rem 0.5rem 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background-color: var(--light);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--dark);
        }
        
        .nav-tab:hover {
            background-color: #dfe4ea;
        }
        
        .nav-tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            background: rgba(255,255,255,0.95);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        
        button {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 2em;
            padding: 0.8em 1.5em;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #341f97;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .transaction-list {
            list-style: none;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .transaction-item:hover {
            background-color: #f9f9f9;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 18px;
        }
        
        .transaction-income {
            color: var(--success);
        }
        
        .transaction-expense {
            color: var(--danger);
        }
        
        .transaction-actions button {
            margin-left: 10px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 5px solid var(--primary);
        }
        
        .summary-card h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--gray);
        }
        
        .summary-card .amount {
            font-size: 24px;
            font-weight: bold;
        }
        
        .summary-income {
            border-left-color: var(--success);
        }
        
        .summary-expenses {
            border-left-color: var(--danger);
        }
        
        .summary-balance {
            border-left-color: var(--primary);
        }
        
        .budget-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .category-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            position: relative;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .category-name {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .category-budget {
            color: var(--primary);
            font-weight: 600;
        }
        
        .category-spent {
            color: var(--danger);
        }
        
        .category-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 50%;
            transition: background-color 0.2s;
            color: var(--gray);
        }
        
        .settings-btn:hover {
            background-color: var(--light);
            color: var(--primary);
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 1rem;
            transition: width 0.3s ease;
        }
        
        .progress-safe {
            background: linear-gradient(90deg, var(--success), #27ae60);
        }
        
        .progress-warning {
            background: linear-gradient(90deg, var(--warning), #e67e22);
        }
        
        .progress-danger {
            background: linear-gradient(90deg, var(--danger), #c0392b);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .footer-links {
            text-align: center;
            margin-top: 2rem;
        }
        
        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Enhanced Dashboard Styles */
        .dashboard-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .dashboard-card {
            background: #f7f9ff;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(108,92,231,0.1);
            border-top: 4px solid var(--accent);
        }

        .dashboard-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .dashboard-income {
            border-top-color: #2e7d32;
        }

        .dashboard-expense {
            border-top-color: #d32f2f;
        }

        .dashboard-balance {
            border-top-color: #4834d4;
        }

        .dashboard-savings {
            border-top-color: #ff6b00;
        }

        .insight-card {
            background: #fffbe6;
            padding: 1.5rem;
            border-radius: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffd700;
        }

        .monthly-breakdown {
            margin: 2rem 0;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .breakdown-table th, .breakdown-table td {
            border: 1px solid #e0e0e0;
            padding: 0.8rem;
            text-align: left;
            font-size: 0.95rem;
        }

        .breakdown-table th {
            background: #4834d4;
            color: #fff;
            font-weight: 600;
        }

        .breakdown-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .category-progress {
            margin: 1rem 0;
        }

        .progress-container {
            background: #e0e0e0;
            border-radius: 1rem;
            overflow: hidden;
            margin: 0.5rem 0;
            height: 20px;
        }

        .progress-fill-enhanced {
            background: linear-gradient(90deg, #6c5ce7, #81ecec);
            height: 100%;
            border-radius: 1rem;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .budget-categories {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .dashboard-overview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">üí∞ Smart Budget ‚Äî Budget Manager</div>
            <div class="user-info">
                Welcome, User! | <a href="login.html" onclick="logout(); return false;" style="color: white;">Logout</a>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="add-transaction">üí∏ Add Transaction</button>
            <button class="nav-tab" data-tab="view-transactions">üìä View Transactions</button>
            <button class="nav-tab" data-tab="budget-summary">üìà Budget Summary</button>
            <button class="nav-tab" data-tab="budget-categories">üéØ Budget Categories</button>
        </div>
        
        <!-- Add Transaction Tab -->
        <div id="add-transaction" class="tab-content active">
            <h2>Add New Transaction</h2>
            <form id="transaction-form">
                <div class="form-group">
                    <label for="transaction-type">Transaction Type</label>
                    <select id="transaction-type" required>
                        <option value="">Select Type</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-category">Category</label>
                    <select id="transaction-category" required>
                        <option value="">Select Category</option>
                        <option value="salary">Salary</option>
                        <option value="freelance">Freelance</option>
                        <option value="investment">Investment</option>
                        <option value="housing">Housing</option>
                        <option value="food">Food</option>
                        <option value="transportation">Transportation</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-amount">Amount ($)</label>
                    <input type="number" id="transaction-amount" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-date">Date</label>
                    <input type="date" id="transaction-date" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-description">Description</label>
                    <input type="text" id="transaction-description" placeholder="Enter a description">
                </div>
                
                <button type="submit" class="btn-success">Add Transaction</button>
            </form>
            
            <div class="footer-links">
                <a href="savings.html">üíæ Go to Savings Page</a>
                <a href="reports.html">üìä View Reports</a>
            </div>
        </div>
        
        <!-- View Transactions Tab -->
        <div id="view-transactions" class="tab-content">
            <h2>Transaction History</h2>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label for="filter-type">Type</label>
                    <select id="filter-type">
                        <option value="all">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-category">Category</label>
                    <select id="filter-category">
                        <option value="all">All Categories</option>
                        <option value="salary">Salary</option>
                        <option value="freelance">Freelance</option>
                        <option value="investment">Investment</option>
                        <option value="housing">Housing</option>
                        <option value="food">Food</option>
                        <option value="transportation">Transportation</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-date">Date Range</label>
                    <select id="filter-date">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <ul class="transaction-list" id="transaction-list">
                <!-- Transactions will be populated here by JavaScript -->
            </ul>
            
            <div class="empty-state" id="empty-transactions">
                <i>üìä</i>
                <h3>No transactions yet</h3>
                <p>Add your first transaction to get started!</p>
            </div>
            
            <div class="footer-links">
                <a href="savings.html">üíæ Go to Savings Page</a>
                <a href="reports.html">üìä View Reports</a>
            </div>
        </div>
        
        <!-- Budget Summary Tab - ENHANCED WITH DASHBOARD FEATURES -->
        <div id="budget-summary" class="tab-content">
            <h2>Budget Summary Dashboard</h2>
            
            <!-- Enhanced Financial Overview -->
            <div class="dashboard-overview" id="financialOverview">
                <div class="dashboard-card dashboard-income">
                    <div class="dashboard-label">Total Income</div>
                    <div class="dashboard-value" id="total-income-value" style="color: #2e7d32;">$0.00</div>
                    <div style="font-size: 0.9rem; color: #666;">All time income</div>
                </div>
                <div class="dashboard-card dashboard-expense">
                    <div class="dashboard-label">Total Expenses</div>
                    <div class="dashboard-value" id="total-expenses-value" style="color: #d32f2f;">$0.00</div>
                    <div style="font-size: 0.9rem; color: #666;">All time expenses</div>
                </div>
                <div class="dashboard-card dashboard-balance">
                    <div class="dashboard-label">Net Balance</div>
                    <div class="dashboard-value" id="net-balance-value" style="color: #4834d4;">$0.00</div>
                    <div style="font-size: 0.9rem; color: #666;">Current balance</div>
                </div>
                <div class="dashboard-card dashboard-savings">
                    <div class="dashboard-label">Savings Rate</div>
                    <div class="dashboard-value" id="savings-rate-value" style="color: #ff6b00;">0%</div>
                    <div style="font-size: 0.9rem; color: #666;">Of income saved</div>
                </div>
            </div>

            <!-- Financial Insights -->
            <div id="financial-insights">
                <h3>üí° Financial Insights</h3>
                <div id="insights-container">
                    <div class="loading">Generating insights...</div>
                </div>
            </div>

            <!-- Monthly Breakdown -->
            <div class="monthly-breakdown">
                <h3>üìÖ Monthly Summary</h3>
                <div id="monthly-summary-container">
                    <div class="loading">Loading monthly summary...</div>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="category-progress">
                <h3>üìä Expense Categories Breakdown</h3>
                <div id="category-breakdown-container">
                    <div class="loading">Loading category breakdown...</div>
                </div>
            </div>
            
            <div class="footer-links">
                <a href="savings.html">üíæ Go to Savings Page</a>
                <a href="reports.html">üìä View Reports</a>
            </div>
        </div>
        
        <!-- Budget Categories Tab -->
        <div id="budget-categories" class="tab-content">
            <h2>Budget Categories</h2>
            <p>Set monthly budgets for different spending categories</p>
            
            <div class="budget-categories" id="categories-container">
                <!-- Categories will be populated here by JavaScript -->
            </div>
            
            <div class="empty-state" id="empty-categories">
                <i>üí∞</i>
                <h3>No budget categories set</h3>
                <p>Set up your budget categories to track your spending</p>
            </div>
            
            <button id="add-category-btn" class="btn-success" style="margin-top: 20px;">Add New Category</button>
            
            <div class="footer-links">
                <a href="savings.html">üíæ Go to Savings Page</a>
                <a href="reports.html">üìä View Reports</a>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Budget Category</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            <form id="category-settings-form">
                <input type="hidden" id="edit-category-id">
                <div class="form-group">
                    <label for="edit-category-name">Category Name</label>
                    <input type="text" id="edit-category-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-category-budget">Monthly Budget ($)</label>
                    <input type="number" id="edit-category-budget" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-category-spent">Amount Spent ($)</label>
                    <input type="number" id="edit-category-spent" min="0" step="0.01" required>
                    <small style="color: var(--gray);">Note: Changing this will manually adjust spending for this category</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-danger" onclick="deleteCategory()">Delete Category</button>
                    <button type="submit" class="btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== DATA MANAGEMENT ====================
        
        // Initialize transactions from localStorage or use sample data
        let transactions = loadTransactionsFromStorage();
        let budgetCategories = [
            { id: 1, name: 'Housing', budget: 1200, spent: 1200 },
            { id: 2, name: 'Food', budget: 400, spent: 350 },
            { id: 3, name: 'Transportation', budget: 200, spent: 150 },
            { id: 4, name: 'Entertainment', budget: 150, spent: 100 },
            { id: 5, name: 'Healthcare', budget: 100, spent: 0 },
            { id: 6, name: 'Other', budget: 200, spent: 0 }
        ];

        // Load transactions from localStorage
        function loadTransactionsFromStorage() {
            try {
                const stored = localStorage.getItem('sb_transactions');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    console.log('Loaded transactions from storage:', parsed.length);
                    return parsed;
                }
            } catch (error) {
                console.error('Error loading transactions from storage:', error);
            }
            
            // Return sample data if nothing in storage or error
            console.log('Using sample transaction data');
            return [
                { 
                    id: 1, 
                    type: 'income', 
                    category: 'salary', 
                    amount: 3500, 
                    date: '2023-10-01', 
                    description: 'Monthly salary',
                    user_id: 'default',
                    createdAt: new Date('2023-10-01').toISOString()
                },
                { 
                    id: 2, 
                    type: 'expense', 
                    category: 'housing', 
                    amount: 1200, 
                    date: '2023-10-03', 
                    description: 'Rent payment',
                    user_id: 'default',
                    createdAt: new Date('2023-10-03').toISOString()
                },
                { 
                    id: 3, 
                    type: 'expense', 
                    category: 'food', 
                    amount: 350, 
                    date: '2023-10-05', 
                    description: 'Groceries',
                    user_id: 'default',
                    createdAt: new Date('2023-10-05').toISOString()
                },
                { 
                    id: 4, 
                    type: 'expense', 
                    category: 'transportation', 
                    amount: 150, 
                    date: '2023-10-07', 
                    description: 'Gas and public transport',
                    user_id: 'default',
                    createdAt: new Date('2023-10-07').toISOString()
                },
                { 
                    id: 5, 
                    type: 'expense', 
                    category: 'entertainment', 
                    amount: 100, 
                    date: '2023-10-10', 
                    description: 'Movie tickets',
                    user_id: 'default',
                    createdAt: new Date('2023-10-10').toISOString()
                },
                { 
                    id: 6, 
                    type: 'income', 
                    category: 'freelance', 
                    amount: 500, 
                    date: '2023-10-15', 
                    description: 'Web design project',
                    user_id: 'default',
                    createdAt: new Date('2023-10-15').toISOString()
                }
            ];
        }

        // Save transactions to localStorage and database
        async function saveTransactionsToStorage() {
            try {
                localStorage.setItem('sb_transactions', JSON.stringify(transactions));
                console.log('Saved transactions to storage:', transactions.length);
                
                // Also update dashboard data for immediate reporting
                updateDashboardData();
                
                // Save to database
                const user_id = localStorage.getItem('sb_user_id') || 'default';
                const userTransactions = transactions.filter(t => t.user_id == user_id);
                
                if (userTransactions.length > 0) {
                    await fetch('api/save_transactions.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: user_id,
                            transactions: userTransactions
                        })
                    });
                    console.log('Transactions saved to database');
                }
                
            } catch (error) {
                console.error('Error saving transactions:', error);
                alert('Error saving transaction data. Please try again.');
            }
        }

        // Update dashboard data for reports
        function updateDashboardData() {
            try {
                const user_id = localStorage.getItem('sb_user_id') || 'default';
                
                // Calculate financial summary
                const totalIncome = transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                const totalExpenses = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                const netBalance = totalIncome - totalExpenses;

                const dashboardData = {
                    summary: {
                        total_income: totalIncome,
                        total_expenses: totalExpenses,
                        net_balance: netBalance
                    },
                    transactions: transactions.slice(-5), // Last 5 transactions
                    last_updated: new Date().toISOString()
                };

                localStorage.setItem('dashboard_data', JSON.stringify(dashboardData));
                console.log('Dashboard data updated for reports');
                
            } catch (error) {
                console.error('Error updating dashboard data:', error);
            }
        }

        // ==================== ENHANCED DASHBOARD FUNCTIONALITY ====================

        // Generate comprehensive financial insights
        function generateFinancialInsights() {
            const container = document.getElementById('insights-container');
            let insights = [];

            const totalIncome = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;

            // Basic financial health insight
            if (netBalance > 0) {
                insights.push(`‚úÖ <strong>Positive Cash Flow:</strong> You're saving $${formatCurrency(netBalance)}. Excellent financial discipline!`);
            } else {
                insights.push(`‚ö†Ô∏è <strong>Negative Cash Flow:</strong> You're spending $${formatCurrency(Math.abs(netBalance))} more than you earn. Consider reviewing expenses.`);
            }

            // Transaction frequency insight
            if (transactions.length > 0) {
                const avgTransaction = (totalIncome + totalExpenses) / transactions.length;
                insights.push(`üìä <strong>Transaction Analysis:</strong> Average transaction amount is ${formatCurrency(avgTransaction)} across ${transactions.length} transactions.`);
            }

            // Category spending insight
            const expenses = transactions.filter(t => t.type === 'expense');
            if (expenses.length > 0) {
                const categories = {};
                expenses.forEach(expense => {
                    const category = expense.category || 'Uncategorized';
                    categories[category] = (categories[category] || 0) + parseFloat(expense.amount || 0);
                });
                
                const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
                if (topCategory) {
                    insights.push(`üéØ <strong>Top Spending Category:</strong> ${formatCategory(topCategory[0])} (${formatCurrency(topCategory[1])})`);
                }
            }

            // Savings rate insight
            const savingsRate = totalIncome > 0 ? ((netBalance / totalIncome) * 100) : 0;
            if (savingsRate > 20) {
                insights.push(`üí∞ <strong>Excellent Savings Rate:</strong> You're saving ${savingsRate.toFixed(1)}% of your income!`);
            } else if (savingsRate > 10) {
                insights.push(`üëç <strong>Good Savings Rate:</strong> You're saving ${savingsRate.toFixed(1)}% of your income.`);
            } else if (savingsRate > 0) {
                insights.push(`üí™ <strong>Building Savings:</strong> You're saving ${savingsRate.toFixed(1)}% of your income.`);
            }

            if (insights.length === 0) {
                insights.push('üí´ <strong>Welcome!</strong> Start by adding your first expense, income, or savings goal to get personalized insights.');
            }

            container.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    ${insight}
                </div>
            `).join('');
        }

        // Generate monthly summary
        function generateMonthlySummary() {
            const container = document.getElementById('monthly-summary-container');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>üìÖ</i><h3>No data available for monthly summary</h3><p>Add transactions to see monthly trends</p></div>';
                return;
            }

            // Group transactions by month
            const monthly = {};
            transactions.forEach(t => {
                const date = t.date || t.createdAt;
                if (!date) return;
                
                const month = getMonth(date);
                if (!monthly[month]) monthly[month] = { income: 0, expenses: 0, transactions: 0 };
                
                if (t.type === 'income') {
                    monthly[month].income += parseFloat(t.amount || 0);
                } else {
                    monthly[month].expenses += parseFloat(t.amount || 0);
                }
                monthly[month].transactions++;
            });

            const months = Object.keys(monthly).sort((a, b) => new Date(b) - new Date(a));
            
            if (months.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>üìÖ</i><h3>No monthly data available</h3><p>Add transactions to see monthly trends</p></div>';
                return;
            }

            // Show only last 6 months for better readability
            const recentMonths = months.slice(0, 6);

            container.innerHTML = `
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Income</th>
                            <th>Expenses</th>
                            <th>Saved</th>
                            <th>Savings Rate</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentMonths.map(month => {
                            const vals = monthly[month];
                            const saved = vals.income - vals.expenses;
                            const savingsRate = vals.income > 0 ? ((saved / vals.income) * 100) : 0;
                            
                            return `
                                <tr>
                                    <td><strong>${month}</strong></td>
                                    <td style="color: #2e7d32; font-weight: bold;">${formatCurrency(vals.income)}</td>
                                    <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(vals.expenses)}</td>
                                    <td style="color: ${saved >= 0 ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
                                        ${formatCurrency(saved)}
                                    </td>
                                    <td style="color: ${savingsRate >= 0 ? '#2e7d32' : '#d32f2f'};">
                                        ${savingsRate.toFixed(1)}%
                                    </td>
                                    <td>${vals.transactions}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Generate category breakdown
        function generateCategoryBreakdown() {
            const container = document.getElementById('category-breakdown-container');
            
            const expenses = transactions.filter(t => t.type === 'expense');
            
            if (expenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><i>üìä</i><h3>No expense data available</h3><p>Add expense transactions to see category breakdown</p></div>';
                return;
            }

            // Group by category
            const categories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                if (!categories[category]) categories[category] = { total: 0, count: 0 };
                categories[category].total += parseFloat(expense.amount || 0);
                categories[category].count++;
            });

            const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const categoryArray = Object.entries(categories)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total);

            container.innerHTML = `
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount Spent</th>
                            <th>Percentage</th>
                            <th>Transactions</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${categoryArray.map(cat => {
                            const percentage = totalExpenses > 0 ? (cat.total / totalExpenses) * 100 : 0;
                            return `
                                <tr>
                                    <td><strong>${formatCategory(cat.name)}</strong></td>
                                    <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(cat.total)}</td>
                                    <td>${percentage.toFixed(1)}%</td>
                                    <td>${cat.count}</td>
                                    <td>
                                        <div class="progress-container" style="margin: 0.5rem 0;">
                                            <div class="progress-fill-enhanced" style="width: ${percentage}%"></div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 1rem; color: #666;">
                    Total Expenses: ${formatCurrency(totalExpenses)} across ${categoryArray.length} categories
                </div>
            `;
        }

        // Update enhanced financial overview
        function updateEnhancedFinancialOverview() {
            const totalIncome = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? ((netBalance / totalIncome) * 100) : 0;

            document.getElementById('total-income-value').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses-value').textContent = formatCurrency(totalExpenses);
            document.getElementById('net-balance-value').textContent = formatCurrency(netBalance);
            document.getElementById('savings-rate-value').textContent = `${savingsRate.toFixed(1)}%`;

            // Update colors based on values
            document.getElementById('net-balance-value').style.color = netBalance >= 0 ? '#2e7d32' : '#d32f2f';
            document.getElementById('savings-rate-value').style.color = savingsRate >= 0 ? '#2e7d32' : '#d32f2f';
        }

        // ==================== SETTINGS MODAL FUNCTIONALITY ====================

        function openSettingsModal(categoryId) {
            const category = budgetCategories.find(c => c.id === categoryId);
            if (!category) return;

            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name;
            document.getElementById('edit-category-budget').value = category.budget;
            document.getElementById('edit-category-spent').value = category.spent;

            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('category-settings-form').reset();
        }

        // Handle category settings form submission
        document.getElementById('category-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryId = parseInt(document.getElementById('edit-category-id').value);
            const newName = document.getElementById('edit-category-name').value.trim();
            const newBudget = parseFloat(document.getElementById('edit-category-budget').value);
            const newSpent = parseFloat(document.getElementById('edit-category-spent').value);

            const categoryIndex = budgetCategories.findIndex(c => c.id === categoryId);
            if (categoryIndex === -1) {
                alert('Category not found!');
                return;
            }

            // Update category
            budgetCategories[categoryIndex].name = newName;
            budgetCategories[categoryIndex].budget = newBudget;
            budgetCategories[categoryIndex].spent = newSpent;

            // Update any transactions that use this category name
            const oldCategoryName = budgetCategories[categoryIndex].name;
            if (oldCategoryName !== newName) {
                transactions.forEach(transaction => {
                    if (transaction.category === oldCategoryName.toLowerCase()) {
                        transaction.category = newName.toLowerCase();
                    }
                });
                saveTransactionsToStorage();
            }

            // Re-render categories
            renderCategories();

            // Close modal
            closeSettingsModal();

            alert('Category updated successfully!');
        });

        function deleteCategory() {
            const categoryId = parseInt(document.getElementById('edit-category-id').value);
            const category = budgetCategories.find(c => c.id === categoryId);
            
            if (!category) return;

            if (confirm(`Are you sure you want to delete the "${category.name}" category? This action cannot be undone.`)) {
                // Remove category
                budgetCategories = budgetCategories.filter(c => c.id !== categoryId);
                
                // Update transactions that use this category to "other"
                transactions.forEach(transaction => {
                    if (transaction.category === category.name.toLowerCase()) {
                        transaction.category = 'other';
                    }
                });
                saveTransactionsToStorage();

                // Re-render categories
                renderCategories();

                // Close modal
                closeSettingsModal();

                alert('Category deleted successfully! Related transactions have been moved to "Other" category.');
            }
        }

        // ==================== UI FUNCTIONALITY ====================

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                // Refresh data when switching to specific tabs
                if (tab.dataset.tab === 'view-transactions') {
                    renderTransactions();
                } else if (tab.dataset.tab === 'budget-summary') {
                    updateEnhancedDashboard();
                } else if (tab.dataset.tab === 'budget-categories') {
                    renderCategories();
                }
            });
        });

        // Enhanced dashboard update function
        function updateEnhancedDashboard() {
            updateEnhancedFinancialOverview();
            generateFinancialInsights();
            generateMonthlySummary();
            generateCategoryBreakdown();
        }

        // Add transaction form submission
        document.getElementById('transaction-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const date = document.getElementById('transaction-date').value;
            const description = document.getElementById('transaction-description').value;
            
            // Get user ID from localStorage or use default
            const user_id = localStorage.getItem('sb_user_id') || 'default';
            
            // Create new transaction with complete data for reports
            const newTransaction = {
                id: Date.now(), // Use timestamp for unique ID
                user_id: user_id,
                type: type,
                category: category,
                amount: amount,
                date: date,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            console.log('Adding new transaction:', newTransaction);
            
            // Add to transactions array
            transactions.push(newTransaction);
            
            // Save to localStorage and database immediately
            await saveTransactionsToStorage();
            
            // Update budget categories if it's an expense
            if (type === 'expense') {
                updateCategorySpending(category, amount);
            }
            
            // Reset form
            this.reset();
            // Set today's date as default
            document.getElementById('transaction-date').valueAsDate = new Date();
            
            // Show success message
            alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} added successfully!\n\nThis transaction is now saved and will appear in your reports.`);
            
            // Update UI if on relevant tabs
            if (document.getElementById('view-transactions').classList.contains('active')) {
                renderTransactions();
            }
            if (document.getElementById('budget-summary').classList.contains('active')) {
                updateEnhancedDashboard();
            }
        });

        // Set today's date as default in the date field
        document.getElementById('transaction-date').valueAsDate = new Date();

        // Render transactions list
        function renderTransactions() {
            const transactionList = document.getElementById('transaction-list');
            const emptyState = document.getElementById('empty-transactions');
            
            // Clear current list
            transactionList.innerHTML = '';
            
            if (transactions.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Get filter values
            const typeFilter = document.getElementById('filter-type').value;
            const categoryFilter = document.getElementById('filter-category').value;
            
            // Filter transactions
            let filteredTransactions = transactions;
            
            if (typeFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            if (categoryFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.category === categoryFilter);
            }
            
            // Sort by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Render transactions
            filteredTransactions.forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'transaction-item';
                
                const amountClass = transaction.type === 'income' ? 'transaction-income' : 'transaction-expense';
                const amountPrefix = transaction.type === 'income' ? '+' : '-';
                
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-category">${formatCategory(transaction.category)}</div>
                        <div class="transaction-description">${transaction.description}</div>
                        <div class="transaction-date">${formatDate(transaction.date)}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">${amountPrefix}$${transaction.amount.toFixed(2)}</div>
                    <div class="transaction-actions">
                        <button class="btn-danger" onclick="deleteTransaction(${transaction.id})">Delete</button>
                    </div>
                `;
                
                transactionList.appendChild(li);
            });
            
            console.log(`Displaying ${filteredTransactions.length} transactions`);
        }

        // Update category spending when a new expense is added
        function updateCategorySpending(category, amount) {
            const categoryObj = budgetCategories.find(c => c.name.toLowerCase() === category);
            if (categoryObj) {
                categoryObj.spent += amount;
                console.log(`Updated category ${category}: spent $${categoryObj.spent}`);
            }
        }

        // Delete transaction
        async function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const transactionIndex = transactions.findIndex(t => t.id === id);
                
                if (transactionIndex !== -1) {
                    const transaction = transactions[transactionIndex];
                    
                    // If it's an expense, subtract from category spending
                    if (transaction.type === 'expense') {
                        const categoryObj = budgetCategories.find(c => c.name.toLowerCase() === transaction.category);
                        if (categoryObj) {
                            categoryObj.spent -= transaction.amount;
                        }
                    }
                    
                    // Remove transaction
                    transactions.splice(transactionIndex, 1);
                    
                    // Save to localStorage and database
                    await saveTransactionsToStorage();
                    
                    // Update UI
                    renderTransactions();
                    updateEnhancedDashboard();
                    
                    console.log(`Deleted transaction: ${transaction.description}`);
                }
            }
        }

        // Update budget summary (legacy function - kept for compatibility)
        function updateSummary() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = totalIncome - totalExpenses;
            
            document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('total-balance').textContent = `$${balance.toFixed(2)}`;
            
            console.log(`Summary updated - Income: $${totalIncome}, Expenses: $${totalExpenses}, Balance: $${balance}`);
        }

        // Update category chart (legacy function - kept for compatibility)
        function updateCategoryChart() {
            const chartContainer = document.getElementById('category-chart');
            
            // Clear current chart
            chartContainer.innerHTML = '';
            
            // Get expense transactions grouped by category
            const expensesByCategory = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!expensesByCategory[t.category]) {
                        expensesByCategory[t.category] = 0;
                    }
                    expensesByCategory[t.category] += t.amount;
                });
            
            if (Object.keys(expensesByCategory).length === 0) {
                chartContainer.innerHTML = `
                    <div class="empty-state">
                        <i>üìà</i>
                        <h3>No spending data yet</h3>
                        <p>Add transactions to see your spending breakdown</p>
                    </div>
                `;
                return;
            }
            
            // Create chart elements
            Object.keys(expensesByCategory).forEach(category => {
                const amount = expensesByCategory[category];
                const card = document.createElement('div');
                card.className = 'category-card';
                
                card.innerHTML = `
                    <div class="category-header">
                        <div class="category-name">${formatCategory(category)}</div>
                        <div class="category-spent">$${amount.toFixed(2)}</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-safe" style="width: ${Math.min(100, (amount / 500) * 100)}%"></div>
                    </div>
                `;
                
                chartContainer.appendChild(card);
            });
        }

        // Render budget categories - UPDATED WITH SETTINGS BUTTON
        function renderCategories() {
            const container = document.getElementById('categories-container');
            const emptyState = document.getElementById('empty-categories');
            
            // Clear container
            container.innerHTML = '';
            
            if (budgetCategories.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Render categories
            budgetCategories.forEach(category => {
                const percentage = (category.spent / category.budget) * 100;
                let progressClass = 'progress-safe';
                
                if (percentage > 75) {
                    progressClass = 'progress-warning';
                }
                if (percentage > 100) {
                    progressClass = 'progress-danger';
                }
                
                const card = document.createElement('div');
                card.className = 'category-card';
                
                card.innerHTML = `
                    <div class="category-header">
                        <div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-budget">Budget: $${category.budget.toFixed(2)}</div>
                        </div>
                        <div class="category-actions">
                            <button class="settings-btn" onclick="openSettingsModal(${category.id})" title="Edit Category">
                                ‚öôÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${Math.min(100, percentage)}%"></div>
                    </div>
                    <div class="category-details">
                        <div class="category-spent">Spent: $${category.spent.toFixed(2)}</div>
                        <div class="category-remaining">Remaining: $${Math.max(0, category.budget - category.spent).toFixed(2)}</div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Add new category
        document.getElementById('add-category-btn').addEventListener('click', function() {
            const name = prompt('Enter category name:');
            if (name) {
                const budget = parseFloat(prompt('Enter monthly budget:'));
                if (!isNaN(budget) && budget > 0) {
                    const newCategory = {
                        id: budgetCategories.length > 0 ? Math.max(...budgetCategories.map(c => c.id)) + 1 : 1,
                        name,
                        budget,
                        spent: 0
                    };
                    
                    budgetCategories.push(newCategory);
                    renderCategories();
                } else {
                    alert('Please enter a valid budget amount.');
                }
            }
        });

        // Helper functions
        function formatCategory(category) {
            return category.charAt(0).toUpperCase() + category.slice(1);
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }

        function getMonth(dateStr) {
            const d = new Date(dateStr);
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            return monthNames[d.getMonth()] + ' ' + d.getFullYear();
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('settings-modal');
            if (event.target === modal) {
                closeSettingsModal();
            }
        });

        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveAllData();
        });

        async function saveAllData() {
            try {
                const user_id = localStorage.getItem('sb_user_id');
                if (!user_id) return;

                // Save any pending data to database
                const userTransactions = transactions.filter(t => t.user_id == user_id);
                
                if (userTransactions.length > 0) {
                    await fetch('api/save_transactions.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: user_id,
                            transactions: userTransactions
                        })
                    });
                }

                console.log('Data saved successfully before page unload');
            } catch (error) {
                console.error('Error saving data before unload:', error);
            }
        }

        async function logout() {
            // Save data before logout
            await saveAllData();
            
            // Clear user data
            localStorage.removeItem('sb_user_id');
            localStorage.removeItem('sb_user_name');
            localStorage.removeItem('sb_user_email');
            localStorage.removeItem('sb_logged_in');
            
            window.location.href = 'login.html';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Budget page initialized');
            console.log('Total transactions:', transactions.length);
            
            renderTransactions();
            updateEnhancedDashboard();
            renderCategories();
            
            // Add event listeners to filters
            document.getElementById('filter-type').addEventListener('change', renderTransactions);
            document.getElementById('filter-category').addEventListener('change', renderTransactions);
            
            // Add link to reports in header
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                const userName = localStorage.getItem('sb_user_name') || 'User';
                userInfo.innerHTML = `Welcome, ${userName}! | <a href="reports.html" style="color: white;">View Reports</a> | <a href="login.html" onclick="logout(); return false;" style="color: white;">Logout</a>`;
            }
        });
    </script>
</body>
</html>