<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Budget — Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ... (all your existing CSS from welcome.html remains exactly the same) ... */
  </style>
</head>
<body>
    <!-- ... (all your existing HTML from welcome.html remains exactly the same) ... -->

    <script>
      // ==================== AUTHENTICATION & NAVIGATION ====================
      
      // Universal navigation function with authentication check
      function navigateTo(page) {
        console.log('Navigating to:', page);
        
        // Check if user is logged in before navigating
        if (!checkLoginStatus()) {
          return false; // Stop navigation if not logged in
        }
        
        // Only navigate if user is authenticated
        window.location.href = page;
        return true;
      }

      // Individual navigation functions
      function goToBudget() {
        navigateTo('Savings.html'); // Updated to point to Savings.html
      }
      
      function goToSavings() {
        navigateTo('Savings.html');
      }
      
      function goToReports() {
        navigateTo('reports.html');
      }
      
      function goToPremium() {
        navigateTo('Premium.html');
      }

      // Enhanced authentication check function
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('sb_logged_in') === 'true';
        const userId = localStorage.getItem('sb_user_id');
        
        if (!isLoggedIn || !userId) {
          alert('Please log in to access this page');
          window.location.href = 'login.html';
          return false;
        }
        
        return true;
      }

      // ==================== SESSION MANAGEMENT ====================
      
      // Check if user is logged in when page loads
      window.addEventListener('DOMContentLoaded', function() {
        // First check login status
        if (!checkLoginStatus()) {
          return; // Stop execution if not logged in
        }
        
        // If logged in, initialize the dashboard
        initializeDashboard();
        
        // Add click event listeners to all navigation elements
        setupNavigation();
      });

      function setupNavigation() {
        // Setup quick action buttons
        const quickActionButtons = document.querySelectorAll('.quick-actions .button');
        quickActionButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            if (href) {
              navigateTo(href);
            }
          });
        });

        // Setup bottom tabs
        const bottomTabs = document.querySelectorAll('.bottom-tabs .tab');
        bottomTabs.forEach(tab => {
          tab.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            if (href && !href.includes('logout')) {
              navigateTo(href);
            }
          });
        });
      }

      // ==================== DASHBOARD FUNCTIONALITY ====================
      
      // Global variables for performance optimization
      let lastDashboardData = null;
      let autoRefreshInterval = null;
      let isRefreshing = false;
      let dataCache = {
        timestamp: 0,
        data: null,
        ttl: 120000 // 2 minutes cache time
      };

      // Set up auto-refresh every 2 minutes
      function startAutoRefresh() {
        autoRefreshInterval = setInterval(() => {
          if (!isRefreshing) {
            refreshDashboard();
          }
        }, 120000); // 2 minutes
      }

      // Clean up interval when page unloads
      window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
      });

      // Check for fresh dashboard data from forms (performance optimization)
      function checkForFreshData() {
        const lastUpdate = localStorage.getItem('last_dashboard_update');
        const lastData = localStorage.getItem('last_dashboard_data');
        
        if (lastUpdate && lastData) {
          const timeSinceUpdate = Date.now() - parseInt(lastUpdate);
          
          // Use fresh data if it's less than 2 minutes old
          if (timeSinceUpdate < 120000) {
            try {
              const freshData = JSON.parse(lastData);
              freshData.success = true;
              updateDashboard(freshData);
              updateLastUpdatedTime();
              console.log('Using fresh dashboard data from form submission');
              
              // Clear the stored data after using it
              localStorage.removeItem('last_dashboard_data');
              localStorage.removeItem('last_dashboard_update');
              return true;
            } catch (error) {
              console.error('Error parsing fresh data:', error);
            }
          }
        }
        return false;
      }

      // Check cache for recent data
      function checkCache() {
        const now = Date.now();
        if (dataCache.data && (now - dataCache.timestamp) < dataCache.ttl) {
          console.log('Using cached dashboard data');
          updateDashboard(dataCache.data);
          updateLastUpdatedTime();
          return true;
        }
        return false;
      }

      async function initializeDashboard() {
        try {
          const user_id = localStorage.getItem('sb_user_id');
          
          if (!user_id) {
            window.location.href = 'login.html';
            return;
          }

          // Update user greeting with actual user data
          const userName = localStorage.getItem('sb_user_name') || 'User';
          document.getElementById('userGreeting').textContent = `Welcome back, ${userName}!`;

          // Performance optimization: Check in this order:
          // 1. Fresh data from forms
          // 2. Cached data
          // 3. Server data
          const hasFreshData = checkForFreshData();
          if (!hasFreshData) {
            const hasCachedData = checkCache();
            if (!hasCachedData) {
              await refreshDashboard();
            }
          }
          
          // Start auto-refresh after initial load
          startAutoRefresh();
          
        } catch (error) {
          console.error('Error initializing dashboard:', error);
          showError('Failed to load dashboard. Please try refreshing the page.');
        }
      }

      async function refreshDashboard() {
        if (isRefreshing) {
          console.log('Refresh already in progress, skipping...');
          return;
        }

        try {
          isRefreshing = true;
          const refreshBtn = document.getElementById('refreshBtn');
          refreshBtn.disabled = true;
          refreshBtn.textContent = '⏳';
          
          const user_id = localStorage.getItem('sb_user_id');
          if (!user_id) return;

          console.log('Refreshing dashboard data...');
          
          // Show loading state only if no data is currently displayed
          if (!lastDashboardData) {
            document.getElementById('recentActivityList').innerHTML = '<p>Refreshing data...</p>';
          }
          
          // Try to load from database first, fallback to localStorage
          let userData;
          try {
            userData = await loadUserDataFromDatabase(user_id);
          } catch (dbError) {
            console.log('Database not available, using localStorage:', dbError);
            userData = await loadUserDataFromLocalStorage(user_id);
          }
          
          // Update cache
          dataCache = {
            timestamp: Date.now(),
            data: userData,
            ttl: 120000
          };
          
          lastDashboardData = userData;
          updateDashboard(userData);
          updateLastUpdatedTime();
          console.log('Dashboard refreshed successfully');
          
        } catch (error) {
          console.error('Error refreshing dashboard:', error);
          
          // Only show error if we don't have any data
          if (!lastDashboardData) {
            showError('Unable to refresh dashboard data. Please try again.');
          }
        } finally {
          isRefreshing = false;
          const refreshBtn = document.getElementById('refreshBtn');
          refreshBtn.disabled = false;
          refreshBtn.textContent = '🔄';
        }
      }

      // NEW: Load data from XAMPP database
      async function loadUserDataFromDatabase(user_id) {
        try {
          const response = await fetch(`http://localhost/smart_budget/get_dashboard_data.php?user_id=${user_id}`);
          
          if (!response.ok) {
            throw new Error('Database request failed');
          }
          
          const data = await response.json();
          
          if (data.success) {
            return data;
          } else {
            throw new Error(data.message || 'Database error');
          }
        } catch (error) {
          console.error('Database load failed:', error);
          throw error; // Re-throw to trigger localStorage fallback
        }
      }

      // Fallback: Load data from localStorage
      async function loadUserDataFromLocalStorage(user_id) {
        // Load transactions and filter by user
        let transactions = JSON.parse(localStorage.getItem('sb_transactions') || '[]');
        transactions = transactions.filter(t => t.user_id == user_id);
        
        // Load goals and filter by user
        let goals = JSON.parse(localStorage.getItem('goalsData') || '[]');
        goals = goals.filter(g => g.user_id == user_id);
        
        // Calculate summary
        const totalIncome = transactions.filter(t => t.type === 'income')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const totalExpenses = transactions.filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const netBalance = totalIncome - totalExpenses;

        return {
          success: true,
          summary: {
            total_income: totalIncome,
            total_expenses: totalExpenses,
            net_balance: netBalance
          },
          expenses: transactions.filter(t => t.type === 'expense'),
          income: transactions.filter(t => t.type === 'income'),
          goals: goals
        };
      }

      // Keep all your existing display functions exactly the same
      function updateDashboard(data) {
        console.log('Updating dashboard with data:', data);
        
        // Update Total Income
        if (data.summary && data.summary.total_income !== undefined) {
          const totalIncome = parseFloat(data.summary.total_income).toFixed(2);
          document.getElementById('totalIncome').textContent = `$${totalIncome}`;
          document.getElementById('totalIncome').style.color = '#2e7d32';
        }

        // Update Total Expenses
        if (data.summary && data.summary.total_expenses !== undefined) {
          const totalExpenses = parseFloat(data.summary.total_expenses).toFixed(2);
          document.getElementById('totalExpenses').textContent = `$${totalExpenses}`;
          document.getElementById('totalExpenses').style.color = '#d32f2f';
        }

        // Update Current Balance (Net Balance)
        if (data.summary && data.summary.net_balance !== undefined) {
          const netBalance = parseFloat(data.summary.net_balance).toFixed(2);
          document.getElementById('netBalance').textContent = `$${netBalance}`;
          document.getElementById('netBalance').style.color = netBalance >= 0 ? '#2e7d32' : '#d32f2f';
        }

        // Update Active Goals Count
        if (data.goals && Array.isArray(data.goals)) {
          const activeGoals = data.goals.filter(goal => 
            goal.status === 'active' || goal.status === 'in progress'
          ).length;
          document.getElementById('activeGoals').textContent = activeGoals;
          document.getElementById('activeGoals').style.color = '#ff6b00';
        }

        // Display recent activity with all financial transactions
        displayRecentActivity(data);
        
        // Display goals progress
        displayGoalsProgress(data.goals);
        
        // Display financial insights
        displayFinancialInsights(data);
      }

      function displayRecentActivity(data) {
        const container = document.getElementById('recentActivityList');
        let activityHTML = '';

        // Combine all financial activities
        const recentItems = [];
        
        // Add expenses
        if (data.expenses && Array.isArray(data.expenses)) {
          data.expenses.slice(0, 10).forEach(expense => {
            recentItems.push({
              type: 'expense',
              amount: expense.amount,
              description: expense.category,
              date: expense.date_spent,
              details: expense.description,
              icon: '💸'
            });
          });
        }

        // Add income
        if (data.income && Array.isArray(data.income)) {
          data.income.slice(0, 10).forEach(income => {
            recentItems.push({
              type: 'income',
              amount: income.amount,
              description: income.source,
              date: income.date_added,
              details: '',
              icon: '💰'
            });
          });
        }

        // Add goal updates
        if (data.goals && Array.isArray(data.goals)) {
          data.goals.slice(0, 5).forEach(goal => {
            if (goal.saved_amount > 0) {
              recentItems.push({
                type: 'savings',
                amount: goal.saved_amount,
                description: `Saved for ${goal.goal_name}`,
                date: goal.updated_at || goal.created_at,
                details: `Progress: ${((goal.saved_amount / goal.target_amount) * 100).toFixed(1)}%`,
                icon: '🎯'
              });
            }
          });
        }

        // Sort by date (newest first)
        recentItems.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (recentItems.length === 0) {
          activityHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
              <p>No financial activity yet.</p>
              <p>Start by adding your first expense or income!</p>
            </div>
          `;
        } else {
          // Use document fragment for better performance with large lists
          recentItems.slice(0, 10).forEach(item => {
            const isIncome = item.type === 'income';
            const isSavings = item.type === 'savings';
            const amountClass = isIncome ? 'activity-income' : 
                              isSavings ? 'activity-income' : 'activity-expense';
            const amountSign = isIncome || isSavings ? '+' : '-';
            
            activityHTML += `
              <div class="activity-item ${amountClass}">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 1.2em;">${item.icon}</span>
                  <div>
                    <strong>${escapeHtml(item.description)}</strong>
                    ${item.details ? `<br><small>${escapeHtml(item.details)}</small>` : ''}
                  </div>
                </div>
                <div style="text-align: right;">
                  <strong style="color: ${isIncome || isSavings ? '#2e7d32' : '#d32f2f'}">
                    ${amountSign}$${parseFloat(item.amount).toFixed(2)}
                  </strong>
                  <br>
                  <small>${new Date(item.date).toLocaleDateString()}</small>
                </div>
              </div>
            `;
          });
        }

        container.innerHTML = activityHTML;
      }

      function displayGoalsProgress(goals) {
        const container = document.getElementById('goalsList');
        const progressSection = document.getElementById('goalsProgress');
        
        if (!goals || !Array.isArray(goals) || goals.length === 0) {
          progressSection.style.display = 'none';
          return;
        }

        progressSection.style.display = 'block';
        
        let goalsHTML = '';
        const activeGoals = goals.filter(goal => 
          goal.status === 'active' || goal.status === 'in progress'
        );
        
        if (activeGoals.length === 0) {
          goalsHTML = `
            <div style="text-align: center; padding: 1rem; color: #666;">
              <p>No active savings goals.</p>
              <a href="Savings.html" class="button" style="display: inline-flex; margin-top: 0.5rem;">
                <span class="action-icon">🎯</span> Create Your First Goal
              </a>
            </div>
          `;
        } else {
          activeGoals.forEach(goal => {
            const progress = Math.min((goal.saved_amount / goal.target_amount) * 100, 100);
            const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
            const progressColor = progress >= 100 ? '#2e7d32' : 
                                progress >= 75 ? '#1976d2' : 
                                progress >= 50 ? '#ff9800' : '#d32f2f';
            
            goalsHTML += `
              <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${progressColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <strong>${escapeHtml(goal.goal_name)}</strong>
                  <span style="font-weight: bold; color: ${progressColor}">${progress.toFixed(1)}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                  <span>$${parseFloat(goal.saved_amount).toFixed(2)} / $${parseFloat(goal.target_amount).toFixed(2)}</span>
                  <span>${daysLeft > 0 ? `${daysLeft} days left` : 'Target reached!'}</span>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 0.3rem;">
                  Status: <strong>${goal.status}</strong>
                </div>
              </div>
            `;
          });
        }

        container.innerHTML = goalsHTML;
      }

      function displayFinancialInsights(data) {
        const container = document.getElementById('quickInsights');
        let insights = [];

        if (data.summary) {
          const netBalance = parseFloat(data.summary.net_balance || 0);
          
          if (netBalance > 0) {
            insights.push('🎉 Excellent! Your finances are in great shape with a positive balance.');
          } else if (netBalance < 0) {
            insights.push('💡 Your expenses exceed your income. Consider reviewing your spending habits.');
          } else {
            insights.push('⚖️ Your income and expenses are balanced. Good financial management!');
          }

          // Expense insights
          if (data.expenses && data.expenses.length > 0) {
            const totalExpenses = parseFloat(data.summary.total_expenses || 0);
            const avgExpense = totalExpenses / data.expenses.length;
            insights.push(`📊 You've recorded ${data.expenses.length} expenses with an average of $${avgExpense.toFixed(2)} each.`);
          }

          // Income insights
          if (data.income && data.income.length > 0) {
            insights.push(`💰 You have ${data.income.length} income sources recorded.`);
          }
        }

        // Goals insights
        if (data.goals && data.goals.some(goal => 
          goal.status === 'active' || goal.status === 'in progress'
        )) {
          const activeGoalsCount = data.goals.filter(goal => 
            goal.status === 'active' || goal.status === 'in progress'
          ).length;
          insights.push(`🎯 You're actively working on ${activeGoalsCount} savings goal${activeGoalsCount !== 1 ? 's' : ''}. Keep going!`);
        }

        if (insights.length === 0) {
          insights.push('💫 Welcome! Start by adding your first expense, income, or savings goal to get personalized insights.');
        }

        container.innerHTML = insights.map(insight => `
          <div style="margin: 0.8rem 0; padding: 0.8rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c5ce7;">
            ${insight}
          </div>
        `).join('');
      }

      function updateLastUpdatedTime() {
        const now = new Date();
        document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
      }

      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          background: #ffebee;
          color: #d32f2f;
          padding: 1rem;
          border-radius: 8px;
          border-left: 4px solid #d32f2f;
          margin: 1rem 0;
        `;
        errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        
        const container = document.querySelector('.container');
        container.insertBefore(errorDiv, container.firstChild);
        
        // Remove error after 5 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 5000);
      }

      function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function logout() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        // Clear all cached data
        dataCache = { timestamp: 0, data: null, ttl: 120000 };
        localStorage.removeItem('sb_user_id');
        localStorage.removeItem('sb_user_name');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_logged_in');
        localStorage.removeItem('last_dashboard_data');
        localStorage.removeItem('last_dashboard_update');
        window.location.href = 'login.html';
      }
    </script>
</body>
</html>