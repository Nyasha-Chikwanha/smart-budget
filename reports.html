<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Budget ‚Äî Reports</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #6c5ce7 0%, #81ecec 100%) fixed;
      color: #222;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0f476a;
      color: #fff;
      text-align: center;
      padding: 1rem 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      background: rgba(255,255,255,0.95);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 6px 24px rgba(0,0,0,0.1);
    }

    h2 {
      color: #4834d4;
      margin-top: 2rem;
      border-bottom: 2px solid #4834d4;
      padding-bottom: 0.3rem;
    }

    .financial-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .summary-card {
      background: #f7f9ff;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(108,92,231,0.1);
      border-top: 4px solid var(--accent);
    }

    .summary-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .income-card {
      border-top-color: #2e7d32;
    }

    .expense-card {
      border-top-color: #d32f2f;
    }

    .balance-card {
      border-top-color: #4834d4;
    }

    .goals-card {
      border-top-color: #ff6b00;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 0.8rem;
      text-align: left;
      font-size: 0.95rem;
    }

    th {
      background: #4834d4;
      color: #fff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: #f1f3f4;
    }

    .status {
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      font-weight: 500;
      display: inline-block;
    }

    .status.reached {
      background: #81ecec;
      color: #055;
    }

    .status.pending {
      background: #ffeaa7;
      color: #6d4c00;
    }

    .status.failed {
      background: #fab1a0;
      color: #6b0b00;
    }

    .motivation-card {
      background: linear-gradient(135deg, #ffeaa7, #fab1a0);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      margin: 2rem 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .motivation-text {
      font-size: 1.3rem;
      font-weight: bold;
      color: #2d3436;
      margin-bottom: 1rem;
    }

    .progress-container {
      background: #e0e0e0;
      border-radius: 1rem;
      overflow: hidden;
      margin: 1rem 0;
      height: 20px;
    }

    .progress-bar {
      background: linear-gradient(90deg, #6c5ce7, #81ecec);
      height: 100%;
      width: 0%;
      border-radius: 1rem;
      transition: width 0.3s ease;
    }

    .category-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .category-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #6c5ce7;
    }

    .back-btn {
      display: inline-block;
      background: #4834d4;
      color: #fff;
      border: none;
      border-radius: 2em;
      padding: 0.8em 1.5em;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 2rem;
      text-decoration: none;
    }

    .back-btn:hover {
      background: #341f97;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .dashboard-save-notice {
      background: #e8f5e8;
      border: 1px solid #2e7d32;
      border-radius: 8px;
      padding: 0.8rem;
      margin: 1rem 0;
      text-align: center;
      color: #2e7d32;
      font-weight: 500;
    }

    .insight-card {
      background: #fffbe6;
      padding: 1.5rem;
      border-radius: 1rem;
      margin: 1rem 0;
      border-left: 4px solid #ffd700;
    }

    .report-section {
      margin: 3rem 0;
    }

    .report-section:first-child {
      margin-top: 0;
    }

    .table-container {
      overflow-x: auto;
      margin: 1rem 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      background: #6c5ce7;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .action-btn:hover {
      background: #5649c0;
    }

    .save-report-btn {
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
      margin-left: 0.5rem;
    }

    .save-report-btn:hover {
      background: #1b5e20;
    }

    .save-report-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @media (max-width: 700px) {
      table {
        font-size: 0.85rem;
      }
      .financial-summary {
        grid-template-columns: 1fr;
      }
      .category-breakdown {
        grid-template-columns: 1fr;
      }
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>üìä Smart Budget ‚Äî Reports</header>

  <main>
    <div id="reportsContent">
      <!-- Dashboard Save Notice -->
      <div id="dashboardSaveNotice" class="dashboard-save-notice" style="display: none;">
        ‚úÖ Dashboard data updated! Your financial overview is now available on the welcome page.
      </div>

      <!-- Financial Summary Section -->
      <section id="summarySection" class="report-section">
        <div class="section-header">
          <h2>üìà Overall Financial Summary</h2>
          <div class="section-actions">
            <button class="save-report-btn" onclick="saveCurrentReport()" id="saveReportBtn">
              üíæ Save Report
            </button>
            <button class="action-btn" onclick="loadSavedReports()">
              üìÅ Load Saved
            </button>
          </div>
        </div>
        <div class="financial-summary" id="financialSummary">
          <div class="loading">Loading your financial summary...</div>
        </div>
      </section>

      <!-- Saved Reports Section -->
      <section id="savedReportsSection" class="report-section" style="display: none;">
        <h2>üìö Saved Reports History</h2>
        <div class="table-container">
          <div id="savedReportsContainer">
            <div class="loading">Loading saved reports...</div>
          </div>
        </div>
      </section>

      <!-- Motivation Section -->
      <section id="motivationSection" class="report-section" style="display: none;">
        <div class="motivation-card">
          <div class="motivation-text" id="motivationText">Keep up the great work!</div>
          <div id="motivationDetails"></div>
        </div>
      </section>

      <!-- All Transactions Section -->
      <section id="transactionsSection" class="report-section">
        <div class="section-header">
          <h2>üí≥ All Transactions</h2>
          <div class="section-actions">
            <button class="action-btn" onclick="exportTransactions()">Export CSV</button>
          </div>
        </div>
        <div class="table-container">
          <div id="transactionsContainer">
            <div class="loading">Loading transactions...</div>
          </div>
        </div>
      </section>

      <!-- Monthly Summary Section -->
      <section id="monthlySummarySection" class="report-section">
        <div class="section-header">
          <h2>üìÖ Monthly Summary</h2>
          <div class="section-actions">
            <button class="action-btn" onclick="toggleMonthlyChart()">Toggle Chart</button>
          </div>
        </div>
        <div class="table-container">
          <div id="monthlySummaryContainer">
            <div class="loading">Loading monthly summary...</div>
          </div>
        </div>
      </section>

      <!-- Category Breakdown Section -->
      <section id="categorySection" class="report-section">
        <div class="section-header">
          <h2>üìä Expense Categories</h2>
          <div class="section-actions">
            <button class="action-btn" onclick="toggleCategoryView()">Toggle View</button>
          </div>
        </div>
        <div id="categoryContainer">
          <div class="loading">Loading category breakdown...</div>
        </div>
      </section>

      <!-- Goals Progress Section -->
      <section id="goalSection" class="report-section">
        <div class="section-header">
          <h2>üéØ Savings Goals Progress</h2>
          <div class="section-actions">
            <button class="action-btn" onclick="sortGoalsByProgress()">Sort by Progress</button>
          </div>
        </div>
        <div class="table-container">
          <div id="goalContainer">
            <div class="loading">Loading goals...</div>
          </div>
        </div>
      </section>

      <!-- Financial Insights Section -->
      <section id="insightsSection" class="report-section">
        <h2>üí° Financial Insights</h2>
        <div id="insightsContainer">
          <div class="loading">Generating insights...</div>
        </div>
      </section>

      <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
        <a href="dashboard.html" class="back-btn">‚¨Ö Back to Dashboard</a>
        <button onclick="refreshReports()" class="back-btn" style="background: #2e7d32;">üîÑ Refresh Reports</button>
        <button onclick="exportToPDF()" class="back-btn" style="background: #d32f2f;">üìÑ Export PDF</button>
      </div>
    </div>
  </main>

  <script>
    // ==================== AUTHENTICATION CHECK ====================
    
    // Check if user is logged in when page loads
    window.addEventListener('DOMContentLoaded', function() {
      if (!checkLoginStatus()) {
        return; // Stop execution if not logged in
      }
      
      // If logged in, load reports
      loadUserReports();
    });

    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('sb_logged_in') === 'true';
      const userId = localStorage.getItem('sb_user_id');
      
      if (!isLoggedIn || !userId) {
        showLoginPrompt();
        return false;
      }
      
      return true;
    }

    function showLoginPrompt() {
      document.getElementById('reportsContent').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
          <h2>Please Log In</h2>
          <p>You need to be logged in to view your financial reports.</p>
          <a href="login.html" class="back-btn">Login</a>
          <a href="dashboard.html" class="back-btn" style="background: #666;">Back to Dashboard</a>
        </div>
      `;
    }

    // ==================== REPORTS FUNCTIONALITY ====================
    
    // Cache for better performance
    let reportsCache = {
      data: null,
      timestamp: 0,
      ttl: 30000 // 30 seconds cache
    };

    // Current report data for saving
    let currentReportData = null;

    async function loadUserReports() {
      const user_id = localStorage.getItem('sb_user_id');
      
      if (!user_id) {
        showLoginPrompt();
        return;
      }

      // Check cache first
      const now = Date.now();
      if (reportsCache.data && (now - reportsCache.timestamp) < reportsCache.ttl) {
        console.log('Using cached reports data');
        generateAllReports(reportsCache.data.transactions, reportsCache.data.goals);
        return;
      }

      try {
        // Load transactions from database
        const transactionsResponse = await fetch('api/get_transactions.php?user_id=' + user_id);
        let transactions = await transactionsResponse.json();
        
        // Load goals from database
        const goalsResponse = await fetch('api/get_goals.php?user_id=' + user_id);
        let goals = await goalsResponse.json();

        // Update cache
        reportsCache = {
          data: { transactions, goals },
          timestamp: now,
          ttl: 30000
        };
        
        // Store current data for potential saving
        currentReportData = { transactions, goals };
        
        generateAllReports(transactions, goals);
        saveDashboardData(transactions, goals);
      } catch (error) {
        console.error('Error loading reports data:', error);
        // Fallback to localStorage
        let transactions = JSON.parse(localStorage.getItem('sb_transactions') || '[]');
        transactions = transactions.filter(t => t.user_id == user_id);
        
        let goals = JSON.parse(localStorage.getItem('goalsData') || '[]');
        goals = goals.filter(g => g.user_id == user_id);
        
        currentReportData = { transactions, goals };
        generateAllReports(transactions, goals);
        saveDashboardData(transactions, goals);
      }
    }

    function generateAllReports(transactions, goals) {
      generateFinancialSummary(transactions);
      generateTransactionsReport(transactions);
      generateMonthlySummary(transactions);
      generateCategoryBreakdown(transactions);
      generateGoalsReport(goals);
      generateMotivation(transactions, goals);
      generateFinancialInsights(transactions, goals);
    }

    // ==================== DATABASE SAVE/LOAD FUNCTIONS ====================

    async function saveCurrentReport() {
      if (!currentReportData) {
        alert('No report data available to save. Please refresh the reports first.');
        return;
      }

      const saveBtn = document.getElementById('saveReportBtn');
      const originalText = saveBtn.innerHTML;
      
      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '‚è≥ Saving...';

        const user_id = localStorage.getItem('sb_user_id');
        const user_name = localStorage.getItem('sb_user_name') || 'Smart Budget User';
        const user_email = localStorage.getItem('sb_user_email') || (user_id + '@smartbudget.com');
        
        // Validate user_id exists
        if (!user_id) {
          throw new Error('User not logged in. Please log in again.');
        }
        
        const currentMonth = getCurrentMonth();
        
        // Calculate financial summary for the report
        const totalIncome = currentReportData.transactions.filter(t => t.type === 'income')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const totalExpenses = currentReportData.transactions.filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const netBalance = totalIncome - totalExpenses;

        const reportData = {
          user_id: user_id,
          user_name: user_name,
          user_email: user_email,
          month: currentMonth,
          total_income: totalIncome,
          total_expense: totalExpenses,
          net_balance: netBalance
        };

        const response = await fetch('api/save_report.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(reportData)
        });

        const result = await response.json();

        if (result.success) {
          let successMessage = '‚úÖ Report saved successfully to database!';
          
          // Add info if user was created
          if (result.user_created) {
            successMessage += ' (New user account created automatically)';
          }
          
          // Show success message
          const notice = document.getElementById('dashboardSaveNotice');
          notice.innerHTML = successMessage;
          notice.style.display = 'block';
          
          setTimeout(() => {
            notice.style.display = 'none';
          }, 5000);
          
          console.log('Report saved successfully:', result);
        } else {
          throw new Error(result.error || 'Failed to save report');
        }

      } catch (error) {
        console.error('Error saving report:', error);
        
        // Show user-friendly error message
        if (error.message.includes('session has expired') || error.message.includes('not logged in')) {
          alert('Your session has expired. Please log in again.');
          window.location.href = 'login.html';
        } else {
          alert('Error saving report: ' + error.message);
        }
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ Save Report';
      }
    }

    async function loadSavedReports() {
      const user_id = localStorage.getItem('sb_user_id');
      if (!user_id) return;

      try {
        const response = await fetch('api/get_reports.php?user_id=' + user_id);
        const reports = await response.json();

        displaySavedReports(reports);
        
      } catch (error) {
        console.error('Error loading saved reports:', error);
        document.getElementById('savedReportsContainer').innerHTML = 
          '<div class="loading">Error loading saved reports. Please try again.</div>';
      }
    }

    function displaySavedReports(reports) {
      const container = document.getElementById('savedReportsContainer');
      const section = document.getElementById('savedReportsSection');

      if (!reports || reports.length === 0) {
        container.innerHTML = '<div class="loading">No saved reports found.</div>';
        section.style.display = 'block';
        return;
      }

      // Sort by creation date (newest first)
      reports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      container.innerHTML = `
        <table id="savedReportsTable">
          <thead>
            <tr>
              <th>Month</th>
              <th>Income</th>
              <th>Expenses</th>
              <th>Net Balance</th>
              <th>Saved On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${reports.map(report => `
              <tr>
                <td><strong>${report.month || 'N/A'}</strong></td>
                <td style="color: #2e7d32; font-weight: bold;">${formatCurrency(report.total_income)}</td>
                <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(report.total_expense)}</td>
                <td style="color: ${report.net_balance >= 0 ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
                  ${formatCurrency(report.net_balance)}
                </td>
                <td>${formatDate(report.created_at)}</td>
                <td>
                  <button class="action-btn" onclick="viewReportDetails(${report.report_id})" style="font-size: 0.8rem;">
                    View Details
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="text-align: center; margin-top: 1rem; color: #666;">
          Showing ${reports.length} saved reports
        </div>
      `;

      section.style.display = 'block';
    }

    function viewReportDetails(reportId) {
      alert('Report details view would be implemented here for report ID: ' + reportId);
      // In a full implementation, this would fetch and display the full report data
    }

    function getCurrentMonth() {
      const d = new Date();
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      return monthNames[d.getMonth()] + ' ' + d.getFullYear();
    }

    // ==================== EXISTING REPORT GENERATION FUNCTIONS ====================

    function generateFinancialSummary(transactions) {
      const container = document.getElementById('financialSummary');
      
      const totalIncome = transactions.filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const totalExpenses = transactions.filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const netBalance = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? ((netBalance / totalIncome) * 100) : 0;

      container.innerHTML = `
        <div class="summary-card income-card">
          <div class="summary-label">Total Income</div>
          <div class="summary-value" style="color: #2e7d32;">${formatCurrency(totalIncome)}</div>
          <div style="font-size: 0.9rem; color: #666;">All time income</div>
        </div>
        <div class="summary-card expense-card">
          <div class="summary-label">Total Expenses</div>
          <div class="summary-value" style="color: #d32f2f;">${formatCurrency(totalExpenses)}</div>
          <div style="font-size: 0.9rem; color: #666;">All time expenses</div>
        </div>
        <div class="summary-card balance-card">
          <div class="summary-label">Net Balance</div>
          <div class="summary-value" style="color: ${netBalance >= 0 ? '#2e7d32' : '#d32f2f'};">${formatCurrency(netBalance)}</div>
          <div style="font-size: 0.9rem; color: #666;">Current balance</div>
        </div>
        <div class="summary-card goals-card">
          <div class="summary-label">Savings Rate</div>
          <div class="summary-value" style="color: #ff6b00;">${savingsRate.toFixed(1)}%</div>
          <div style="font-size: 0.9rem; color: #666;">Of income saved</div>
        </div>
      `;
    }

    function generateTransactionsReport(transactions) {
      const container = document.getElementById('transactionsContainer');
      
      if (!transactions || transactions.length === 0) {
        container.innerHTML = '<div class="loading">No transactions found. Start by adding income or expenses!</div>';
        return;
      }

      // Sort by date (newest first)
      const sortedTransactions = transactions.sort((a, b) => {
        const dateA = new Date(a.date || a.createdAt);
        const dateB = new Date(b.date || b.createdAt);
        return dateB - dateA;
      });

      container.innerHTML = `
        <table id="transactionsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            ${sortedTransactions.map(t => `
              <tr>
                <td>${t.date ? formatDate(t.date) : (t.createdAt ? formatDate(t.createdAt) : '-')}</td>
                <td>
                  <span style="color: ${t.type === 'income' ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
                    ${t.type ? t.type.charAt(0).toUpperCase() + t.type.slice(1) : '-'}
                  </span>
                </td>
                <td>${t.category || '-'}</td>
                <td style="color: ${t.type === 'income' ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
                  ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                </td>
                <td>${t.description || t.desc || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="margin-top: 1rem; text-align: center; color: #666;">
          Showing ${sortedTransactions.length} transactions
        </div>
      `;
    }

    function generateMonthlySummary(transactions) {
      const container = document.getElementById('monthlySummaryContainer');

      if (!transactions || transactions.length === 0) {
        container.innerHTML = '<div class="loading">No data available for monthly summary.</div>';
        return;
      }

      // Group transactions by month
      const monthly = {};
      transactions.forEach(t => {
        const date = t.date || t.createdAt;
        if (!date) return;
        
        const month = getMonth(date);
        if (!monthly[month]) monthly[month] = { income: 0, expenses: 0, transactions: 0 };
        
        if (t.type === 'income') {
          monthly[month].income += parseFloat(t.amount || 0);
        } else {
          monthly[month].expenses += parseFloat(t.amount || 0);
        }
        monthly[month].transactions++;
      });

      const months = Object.keys(monthly).sort((a, b) => new Date(b) - new Date(a));
      
      if (months.length === 0) {
        container.innerHTML = '<div class="loading">No monthly data available.</div>';
        return;
      }

      container.innerHTML = `
        <table id="monthlySummaryTable">
          <thead>
            <tr>
              <th>Month</th>
              <th>Income</th>
              <th>Expenses</th>
              <th>Saved</th>
              <th>Savings Rate</th>
              <th>Transactions</th>
            </tr>
          </thead>
          <tbody>
            ${months.map(month => {
              const vals = monthly[month];
              const saved = vals.income - vals.expenses;
              const savingsRate = vals.income > 0 ? ((saved / vals.income) * 100) : 0;
              
              return `
                <tr>
                  <td><strong>${month}</strong></td>
                  <td style="color: #2e7d32; font-weight: bold;">${formatCurrency(vals.income)}</td>
                  <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(vals.expenses)}</td>
                  <td style="color: ${saved >= 0 ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
                    ${formatCurrency(saved)}
                  </td>
                  <td style="color: ${savingsRate >= 0 ? '#2e7d32' : '#d32f2f'};">
                    ${savingsRate.toFixed(1)}%
                  </td>
                  <td>${vals.transactions}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function generateCategoryBreakdown(transactions) {
      const container = document.getElementById('categoryContainer');
      
      const expenses = transactions.filter(t => t.type === 'expense');
      
      if (expenses.length === 0) {
        container.innerHTML = '<div class="loading">No expense data available for category breakdown.</div>';
        return;
      }

      // Group by category
      const categories = {};
      expenses.forEach(expense => {
        const category = expense.category || 'Uncategorized';
        if (!categories[category]) categories[category] = { total: 0, count: 0 };
        categories[category].total += parseFloat(expense.amount || 0);
        categories[category].count++;
      });

      const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const categoryArray = Object.entries(categories)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.total - a.total);

      container.innerHTML = `
        <table id="categoryTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount Spent</th>
              <th>Percentage</th>
              <th>Transactions</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody>
            ${categoryArray.map(cat => {
              const percentage = totalExpenses > 0 ? (cat.total / totalExpenses) * 100 : 0;
              return `
                <tr>
                  <td><strong>${cat.name}</strong></td>
                  <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(cat.total)}</td>
                  <td>${percentage.toFixed(1)}%</td>
                  <td>${cat.count}</td>
                  <td>
                    <div class="progress-container" style="margin: 0.5rem 0;">
                      <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        <div style="text-align: center; margin-top: 1rem; color: #666;">
          Total Expenses: ${formatCurrency(totalExpenses)} across ${categoryArray.length} categories
        </div>
      `;
    }

    function generateGoalsReport(goals) {
      const container = document.getElementById('goalContainer');
      
      if (!goals || goals.length === 0) {
        container.innerHTML = `
          <div class="loading">
            <p>No goals set yet.</p>
            <p><a href="Savings.html" style="color: #4834d4; text-decoration: underline;">Create your first savings goal</a> to start tracking your progress!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table id="goalTable">
          <thead>
            <tr>
              <th>Goal Name</th>
              <th>Target Amount</th>
              <th>Saved Amount</th>
              <th>Progress</th>
              <th>Deadline</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${goals.map(goal => {
              const currentAmount = parseFloat(goal.current_amount || goal.savedAmount || goal.current || 0);
              const targetAmount = parseFloat(goal.target_amount || goal.goalAmount || goal.target);
              const progress = targetAmount > 0 ? (currentAmount / targetAmount) * 100 : 0;
              let status = "Pending";
              let statusClass = "pending";
              
              const deadline = goal.deadline || goal.goalDate;
              if (progress >= 100) {
                status = "Reached";
                statusClass = "reached";
              } else if (deadline && new Date(deadline) < new Date() && progress < 100) {
                status = "Failed";
                statusClass = "failed";
              }

              const daysLeft = deadline ? Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24)) : null;
              
              return `
                <tr>
                  <td><strong>${goal.name || goal.goalName || 'Unnamed Goal'}</strong></td>
                  <td>${formatCurrency(targetAmount)}</td>
                  <td>${formatCurrency(currentAmount)}</td>
                  <td>
                    <div style="background: #e0e0e0; border-radius: 10px; height: 8px; margin: 4px 0;">
                      <div style="background: ${progress >= 100 ? '#2e7d32' : progress >= 50 ? '#1976d2' : '#ff9800'}; 
                           height: 100%; width: ${Math.min(progress, 100)}%; border-radius: 10px;"></div>
                    </div>
                    <small>${progress.toFixed(1)}%</small>
                  </td>
                  <td>${deadline ? formatDate(deadline) : 'No deadline'} 
                    ${daysLeft > 0 ? `<br><small>(${daysLeft} days left)</small>` : ''}
                  </td>
                  <td><span class="status ${statusClass}">${status}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function generateMotivation(transactions, goals) {
      const section = document.getElementById('motivationSection');
      const textElement = document.getElementById('motivationText');
      const detailsElement = document.getElementById('motivationDetails');
      
      const totalIncome = transactions.filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const totalExpenses = transactions.filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const netBalance = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? ((netBalance / totalIncome) * 100) : 0;

      let motivation = "";
      let details = "";
      
      if (netBalance > 0) {
        if (savingsRate > 20) {
          motivation = "üéâ Outstanding! You're saving more than 20% of your income!";
          details = `You've saved ${formatCurrency(netBalance)} (${savingsRate.toFixed(1)}% of income). Keep building that financial security!`;
        } else if (savingsRate > 10) {
          motivation = "üëç Great job! You're building good savings habits!";
          details = `You've saved ${formatCurrency(netBalance)} (${savingsRate.toFixed(1)}% of income). Consider increasing to 20% for even better results.`;
        } else {
          motivation = "üí™ Good start! Every bit of savings counts!";
          details = `You've saved ${formatCurrency(netBalance)}. Try to reach 10-20% savings rate for optimal financial health.`;
        }
      } else {
        motivation = "üìù Time to review your spending habits!";
        details = `You're spending ${formatCurrency(Math.abs(netBalance))} more than you earn. Consider creating a budget to get back on track.`;
      }

      // Add goal motivation if there are active goals
      const activeGoals = goals.filter(g => g.status === 'active' || !g.status);
      if (activeGoals.length > 0) {
        const totalGoalProgress = activeGoals.reduce((sum, goal) => {
          const current = parseFloat(goal.current_amount || goal.savedAmount || goal.current || 0);
          const target = parseFloat(goal.target_amount || goal.goalAmount || goal.target);
          return sum + (target > 0 ? current / target : 0);
        }, 0) / activeGoals.length * 100;
        
        if (totalGoalProgress > 75) {
          motivation += " You're crushing your savings goals! üéØ";
        } else if (totalGoalProgress > 50) {
          motivation += " You're making solid progress on your goals! üí∞";
        }
      }

      textElement.textContent = motivation;
      detailsElement.innerHTML = `<p>${details}</p>`;
      section.style.display = 'block';
    }

    function generateFinancialInsights(transactions, goals) {
      const container = document.getElementById('insightsContainer');
      let insights = [];

      const totalIncome = transactions.filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const totalExpenses = transactions.filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const netBalance = totalIncome - totalExpenses;

      // Basic financial health insight
      if (netBalance > 0) {
        insights.push(`‚úÖ <strong>Positive Cash Flow:</strong> You're saving ${formatCurrency(netBalance)} monthly. Excellent financial discipline!`);
      } else {
        insights.push(`‚ö†Ô∏è <strong>Negative Cash Flow:</strong> You're spending ${formatCurrency(Math.abs(netBalance))} more than you earn. Consider reviewing expenses.`);
      }

      // Transaction frequency insight
      if (transactions.length > 0) {
        const avgTransaction = (totalIncome + totalExpenses) / transactions.length;
        insights.push(`üìä <strong>Transaction Analysis:</strong> Average transaction amount is ${formatCurrency(avgTransaction)} across ${transactions.length} transactions.`);
      }

      // Category spending insight
      const expenses = transactions.filter(t => t.type === 'expense');
      if (expenses.length > 0) {
        const categories = {};
        expenses.forEach(expense => {
          const category = expense.category || 'Uncategorized';
          categories[category] = (categories[category] || 0) + parseFloat(expense.amount || 0);
        });
        
        const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
        if (topCategory) {
          insights.push(`üéØ <strong>Top Spending Category:</strong> ${topCategory[0]} (${formatCurrency(topCategory[1])})`);
        }
      }

      // Goals progress insight
      const activeGoals = goals.filter(g => g.status === 'active' || !g.status);
      if (activeGoals.length > 0) {
        insights.push(`üéØ <strong>Active Goals:</strong> You're working on ${activeGoals.length} savings goal${activeGoals.length !== 1 ? 's' : ''}. Stay focused!`);
      }

      if (insights.length === 0) {
        insights.push('üí´ <strong>Welcome!</strong> Start by adding your first expense, income, or savings goal to get personalized insights.');
      }

      container.innerHTML = insights.map(insight => `
        <div class="insight-card">
          ${insight}
        </div>
      `).join('');
    }

    function saveDashboardData(transactions, goals) {
      try {
        const user_id = localStorage.getItem('sb_user_id');
        if (!user_id) return;

        // Calculate financial summary
        const totalIncome = transactions.filter(t => t.type === 'income')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const totalExpenses = transactions.filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        const netBalance = totalIncome - totalExpenses;
        const activeGoals = goals.filter(g => g.status === 'active' || !g.status).length;

        const dashboardData = {
          summary: {
            total_income: totalIncome,
            total_expenses: totalExpenses,
            net_balance: netBalance
          },
          transactions: transactions.slice(0, 5), // Recent transactions
          goals: goals,
          active_goals_count: activeGoals,
          last_updated: new Date().toISOString()
        };

        // Save to localStorage for dashboard to access
        localStorage.setItem('dashboard_data', JSON.stringify(dashboardData));
        
        // Show success notice
        const notice = document.getElementById('dashboardSaveNotice');
        notice.style.display = 'block';
        
        // Hide notice after 5 seconds
        setTimeout(() => {
          notice.style.display = 'none';
        }, 5000);

        console.log('Dashboard data saved:', dashboardData);
        
      } catch (error) {
        console.error('Error saving dashboard data:', error);
      }
    }

    function refreshReports() {
      // Clear cache and reload
      reportsCache = { data: null, timestamp: 0, ttl: 30000 };
      currentReportData = null;
      loadUserReports();
    }

    function exportToPDF() {
      alert('PDF export functionality would be implemented here!');
      // In a real implementation, this would generate and download a PDF report
    }

    // Additional UI functions
    function exportTransactions() {
      alert('CSV export functionality would be implemented here!');
    }

    function toggleMonthlyChart() {
      alert('Chart toggle functionality would be implemented here!');
    }

    function toggleCategoryView() {
      alert('Category view toggle functionality would be implemented here!');
    }

    function sortGoalsByProgress() {
      alert('Goals sorting functionality would be implemented here!');
    }

    // Utility functions
    function getMonth(dateStr) {
      const d = new Date(dateStr);
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      return monthNames[d.getMonth()] + ' ' + d.getFullYear();
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount || 0);
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleDateString();
    }

    // Save data before page unload
    window.addEventListener('beforeunload', function() {
      saveAllData();
    });

    async function saveAllData() {
      try {
        const user_id = localStorage.getItem('sb_user_id');
        if (!user_id) return;

        // Save any pending data to database
        const transactions = JSON.parse(localStorage.getItem('sb_transactions') || '[]');
        const userTransactions = transactions.filter(t => t.user_id == user_id);
        
        if (userTransactions.length > 0) {
          await fetch('api/save_transactions.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user_id: user_id,
              transactions: userTransactions
            })
          });
        }

        console.log('Data saved successfully before page unload');
      } catch (error) {
        console.error('Error saving data before unload:', error);
      }
    }
  </script>
</body>
</html>